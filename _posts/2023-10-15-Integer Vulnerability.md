---
title: Integer Vulnerability
date: 2023-10-01 01:22:14 +09:00
categories: [Study, Secure Coding]
tags: [integer, vuln]     # TAG names should always be lowercase
math: true
mermaid: true
---

### 실행 내용
> A. Perform (demonstrate) the underflow and overflow<br>
B. Update the code so that the above vulnerabilities are not possible

### 시나리오
> 1. Customer가 balance를 입력하고 구매하고자 하는 상품의 quantity를 입력하면 화면에서 total금액, store balance, customer balance를 확인할 수 있는 프로그램 작성<br>
   - **A. Integer overflow와 underflow를 보여준다.**
     - Customer이 int의 max만큼 Apple을 사고싶다고 가정한다. 이때, Customer의 balance는 0 이다.
     - 이후 같은 Customer이 Apple을 2개 더 사게되면 Integer overflow, underflow를 확인할 수 있다.<br>
   - **B. Integer overflow와 underflow를 발생시키는 코드를 수정한다.**
     - Customer의 balance를 확인하는 코드를 추가한다.


### PART A

#### Integer Vulnerable program
![Program Test](assets/img/_POST/Integer Vulnerability/image1.png)
> 동일한 Customer가 10달러를 가지고 Apple 3개를 구입하고 Mango 2개를 구입<br>
Customer Balance = 10 - 3 - 4 = 3<br>
Store Balance = 0 + 3 + 4 = 7<br>
※ Customer은 첫 구매 후에는 Balance를 입력하지 않아도 됨. 프로그램이 이전에 제공한 잔액을 기억하고 이전 구매 내역을 고려하여 지속적으로 업데이트함.



#### Integer Overflow & Underflow

[INT Ranges](https://learn.microsoft.com/en-us/cpp/cpp/data-type-ranges?view=msvc-170)<br>
Int값의 범위는 -2,147,483,648 ~ 2,147,483,647 이다. 따라서 해당 범위를 벗어나게 되면 Overflow와 Underflow가 발생한다.  
![Integer Overflow, Underflow](assets/img/_POST/Integer Vulnerability/image2.png)

> 1. Customer가 int의 max(2147483647)만큼 apple을 구매하며, Customer balance는 0달러이다.<br>
	-> Customer balance는 0이었기 때문에 -2147483647 가 되고, Store balance는 2147483647 가 된다. 
2. 같은 Customer은 2개의 apple을 추가로 구매한다.<br>
	-> Customer balance = -2147483647 - 2 = -2147483649 (Integer Underflow)<br>
    -> Store balance = 2147483647 + 2 = 2147483649 (Integer Overflow)<br>
 	-> Customer balance는 Integer Underflow가 발생하여 양수값으로 변경되었고 Store Balance는 Integer Overflow가 발생하여 음수값으로 변하였다.<br>
❗Customer은 balance를 0달러를 가지고 있었지만 현재 2147483647달러를 가지고 있게 된다.

---

### PART B
#### Code Update

**\<현재 코드\>**
```java
if(rb1.isSelected()){
                    rows[1] = "Apple";
                    store_balance += 1*Integer.parseInt(rows[2]);
                    customer_balance -= 1*Integer.parseInt(rows[2]);
                    total_purchase = 1*Integer.parseInt(rows[2]);
                }
                else if(rb2.isSelected()){
                    rows[1] = "Mango";
                    store_balance += 2*Integer.parseInt(rows[2]);
                    customer_balance -= 2*Integer.parseInt(rows[2]);
                    total_purchase = 2 * Integer.parseInt(rows[2]);
                }
                else if(rb3.isSelected()){
                    rows[1] = "Banana";
                    store_balance += 3*Integer.parseInt(rows[2]);
                    customer_balance -= 3*Integer.parseInt(rows[2]);
                    total_purchase = 3*Integer.parseInt(rows[2]);
                }
                else{
                    rows[1] = "Orange";
                    store_balance += 4*Integer.parseInt(rows[2]);
                    customer_balance -= 4*Integer.parseInt(rows[2]);
                    total_purchase = 4*Integer.parseInt(rows[2]);
                }
```

> 현재 코드에서 Integer overflow와 underflow가 발생하는 이유는 고객의 잔고가 줄어드는지를 확인하지 않기 떄문에 발생한다. 따라서 Customer의 balance가 0보다 작다면 경고문을 띄우고 프로세스를 종료하는 코드를 추가한다.



**\<Update 코드\>**
```java
if(rb1.isSelected()){
                    rows[1] = "Apple";
                    store_balance += 1*Integer.parseInt(rows[2]);
                    customer_balance -= 1*Integer.parseInt(rows[2]);
                    if(customer_balance<0) {
                        alert.showMessageDialog(null, "You don't have enough money!"); return;
                    }
                    else total_purchase = 1*Integer.parseInt(rows[2]);
                }
                else if(rb2.isSelected()){
                    rows[1] = "Mango";
                    store_balance += 2*Integer.parseInt(rows[2]);
                    customer_balance -= 2*Integer.parseInt(rows[2]);
                    if(customer_balance<0) {
                        alert.showMessageDialog(null, "You don't have enough money!"); return;
                    }
                    else total_purchase = 2*Integer.parseInt(rows[2]);
                }
                else if(rb3.isSelected()){
                    rows[1] = "Banana";
                    store_balance += 3*Integer.parseInt(rows[2]);
                    customer_balance -= 3*Integer.parseInt(rows[2]);
                    if(customer_balance<0) {
                        alert.showMessageDialog(null, "You don't have enough money!"); return;
                    }
                    else total_purchase = 3*Integer.parseInt(rows[2]);
                }
                else{
                    rows[1] = "Orange";
                    store_balance += 4*Integer.parseInt(rows[2]);
                    customer_balance -= 4*Integer.parseInt(rows[2]);
                    if(customer_balance<0) {
                        alert.showMessageDialog(null, "You don't have enough money!"); return;
                    }
                    else total_purchase = 4*Integer.parseInt(rows[2]);
                }
```
![](assets/img/_POST/Integer Vulnerability/image3.png)
![](assets/img/_POST/Integer Vulnerability/image4.png)


---

### 전체 코드
```java
package cashR;

import java.awt.BorderLayout;
import java.awt.GridLayout;
import java.awt.event.*;
import java.util.ArrayList;

import javax.swing.*;
import javax.swing.table.DefaultTableModel;
public class SecureCoding<MemberV0> extends JFrame {
    private static final long serialVersionUID = 1L;
    ArrayList<MemberV0> members = new ArrayList<MemberV0>();
    int store_balance = 0; // 매장 잔액
    int customer_balance = 0; // 고객 잔액
    int total_purchase = 0; // 전체 금액

    public  SecureCoding(){
        setTitle("Secure Coding");
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        setAlwaysOnTop(true);
        setBounds(200,100,800,200);

        String[] colNames = new String[] {"Customer Name", "Fruit","Quantity", "Total Purchase($)", "Customer Balance($)", "Store Balance($)"};
        DefaultTableModel model = new DefaultTableModel(colNames,0);

        JTable table = new JTable(model);
        JScrollPane scrollPane = new JScrollPane(table);
        add(scrollPane,BorderLayout.CENTER);

        JPanel bottomPanel = new JPanel();
        bottomPanel.setLayout(new GridLayout(2,1));

        JPanel panel = new JPanel();
        JTextField tfName = new JTextField(6);
        JTextField tfQua = new JTextField(15);
        JTextField tfCusBal = new JTextField(4);
        JRadioButton rb1 = new JRadioButton("Apple: 1$");
        JRadioButton rb2 = new JRadioButton("Mango: 2$");
        JRadioButton rb3 = new JRadioButton("Banana: 3$");
        JRadioButton rb4 = new JRadioButton("Orange: 4$");
        JRadioButton rb5 = new JRadioButton();
        ButtonGroup rg = new ButtonGroup();

        rg.add(rb1); rg.add(rb2); rg.add(rb3); rg.add(rb4); rg.add(rb5);
        rb1.setSelected(true);

        panel.add(new JLabel("NAME"));
        panel.add(tfName);
        panel.add(new JLabel("Quantity"));
        panel.add(tfQua);
        panel.add(new JLabel("Balance($)"));
        panel.add(tfCusBal);
        panel.add(rb1); panel.add(rb2); panel.add(rb3); panel.add(rb4);
        bottomPanel.add(panel);

        JPanel panel2 = new JPanel();
        JButton btnAdd = new JButton("Add");
        JButton btnDel = new JButton("Delete");
        panel2.add(btnAdd); panel2.add(btnDel);
        bottomPanel.add(panel2);

        btnAdd.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                String[] rows = new String[7];
                JOptionPane alert = new JOptionPane();
                rows[0] = tfName.getText();
                rows[2] = tfQua.getText();
                rows[6] = tfCusBal.getText();

                if(members.size()!=0){
                    for(int i=members.size()-1; i>-1; i--){
                        if((members.get(i).name).equals(rows[0]))
                        {
                            customer_balance = members.get(i).customer;
                            System.out.println("Same Customer: "+customer_balance);
                            break;
                        }
                        else customer_balance = Integer.parseInt(rows[6]);
                    }
                }
                else customer_balance = Integer.parseInt(rows[6]);

                if(rb1.isSelected()){
                    rows[1] = "Apple";
                    store_balance += 1*Integer.parseInt(rows[2]);
                    customer_balance -= 1*Integer.parseInt(rows[2]);
                    /*
                    if(customer_balance<0) {
                        alert.showMessageDialog(null, "You don't have enough money!"); return;
                    }
                    else total_purchase = 1*Integer.parseInt(rows[2]);
                    */
                    total_purchase = 1*Integer.parseInt(rows[2]);
                }
                else if(rb2.isSelected()){
                    rows[1] = "Mango";
                    store_balance += 2*Integer.parseInt(rows[2]);
                    customer_balance -= 2*Integer.parseInt(rows[2]);
                    /*
                    if(customer_balance<0) {
                        alert.showMessageDialog(null, "You don't have enough money!"); return;
                    }
                    else total_purchase = 2*Integer.parseInt(rows[2]);

                     */
                    total_purchase = 2 * Integer.parseInt(rows[2]);
                }
                else if(rb3.isSelected()){
                    rows[1] = "Banana";
                    store_balance += 3*Integer.parseInt(rows[2]);
                    customer_balance -= 3*Integer.parseInt(rows[2]);
                    /*
                    if(customer_balance<0) {
                        alert.showMessageDialog(null, "You don't have enough money!"); return;
                    }
                    else total_purchase = 3*Integer.parseInt(rows[2]);

                     */
                    total_purchase = 3*Integer.parseInt(rows[2]);
                }
                else{
                    rows[1] = "Orange";
                    store_balance += 4*Integer.parseInt(rows[2]);
                    customer_balance -= 4*Integer.parseInt(rows[2]);
                    /*
                    if(customer_balance<0) {
                        alert.showMessageDialog(null, "You don't have enough money!"); return;
                    }
                    else total_purchase = 4*Integer.parseInt(rows[2]);

                     */
                    total_purchase = 4*Integer.parseInt(rows[2]);
                }

                rows[5] = Integer.toString(store_balance);
                rows[4] = Integer.toString(customer_balance);
                rows[3] = Integer.toString(total_purchase);
                model.addRow(rows);

                tfName.setText("");
                tfQua.setText("");
                total_purchase =0;

                rb3.setSelected(true);

                String name = rows[0];
                int qua = Integer.parseInt(rows[2]);
                String fruit = rows[1];

                members.add(new MemberV0(name, fruit,qua, store_balance, customer_balance, total_purchase));

            }
        });
        btnDel.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                int rowIndex = table.getSelectedRow();

                if(rowIndex==-1) return;
                model.removeRow(rowIndex);

                members.remove(rowIndex);
            }
        });
        add(bottomPanel, BorderLayout.SOUTH);
        setVisible(true);
    }
    class MemberV0{
        private String name;
        private String fruit;
        private int qua;
        private int total;
        private int customer;
        private int store;

        public MemberV0(String name, String fruit, int qua, int total, int customer, int store){
            this.name = name;
            this.fruit = fruit;
            this.qua = qua;
            this.total =total;
            this.customer = customer;
            this.store = store;
        }
    }
    public static void main(String[] args){
        new SecureCoding();
    }
}

```

